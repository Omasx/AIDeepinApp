<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DePIN Cloud Gaming - Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }

        #game-stream {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
            background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(98, 0, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(98, 0, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #stats {
            position: fixed;
            top: 10px;
            right: 10px;
            color: #0f0;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #0f0;
            font-family: 'Courier New', monospace;
            z-index: 100;
            min-width: 200px;
        }

        .stat-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            color: #0f0;
        }

        .stat-value {
            color: #0ff;
            font-weight: bold;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected {
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
        }

        .status-connecting {
            background: #ff0;
            box-shadow: 0 0 10px #ff0;
            animation: pulse 1s infinite;
        }

        .status-disconnected {
            background: #f00;
            box-shadow: 0 0 10px #f00;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #info-panel {
            position: fixed;
            bottom: 100px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #6200ea;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        .info-title {
            color: #6200ea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .info-item {
            margin: 5px 0;
            color: #ccc;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 200;
            display: none;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #6200ea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error-message {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 200;
            display: none;
            max-width: 80%;
            text-align: center;
        }

        /* Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³ */
        #touch-controls {
            position: fixed;
            bottom: 100px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .touch-btn {
            width: 50px;
            height: 50px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <!-- Ø§Ù„Ø¨Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <video id="game-stream" autoplay playsinline muted></video>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div id="connection-status">
        <span class="status-indicator status-disconnected"></span>
        <span id="status-text">ØºÙŠØ± Ù…ØªØµÙ„</span>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="stats">
        <div class="stat-item">
            <span class="stat-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
            <span class="stat-value" id="status">ØºÙŠØ± Ù…ØªØµÙ„</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Bitrate:</span>
            <span class="stat-value" id="bitrate">0 Mbps</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Latency:</span>
            <span class="stat-value" id="latency">0 ms</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">FPS:</span>
            <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©:</span>
            <span class="stat-value" id="packets">0</span>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div id="info-panel">
        <div class="info-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</div>
        <div class="info-item">
            <strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:</strong> <span id="server-addr">-</span>
        </div>
        <div class="info-item">
            <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> <span id="conn-state">-</span>
        </div>
        <div class="info-item">
            <strong>Ù†ÙˆØ¹ Ø§Ù„Ø§ØªØµØ§Ù„:</strong> <span id="conn-type">-</span>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading">
        <div class="spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
    <div id="error-message"></div>

    <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³ -->
    <div id="touch-controls">
        <button class="touch-btn" id="up-btn" title="Ø§Ù„Ø£Ø¹Ù„Ù‰">â¬†ï¸</button>
        <button class="touch-btn" id="down-btn" title="Ø§Ù„Ø£Ø³ÙÙ„">â¬‡ï¸</button>
        <button class="touch-btn" id="left-btn" title="Ø§Ù„ÙŠØ³Ø§Ø±">â¬…ï¸</button>
        <button class="touch-btn" id="right-btn" title="Ø§Ù„ÙŠÙ…ÙŠÙ†">â¡ï¸</button>
    </div>

    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="controls">
        <button id="connect-btn">ğŸ”— Ø§ØªØµÙ„</button>
        <button id="disconnect-btn" disabled>âŒ Ù‚Ø·Ø¹</button>
        <button id="fullscreen-btn">â›¶ Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø©</button>
        <button id="info-btn">â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
    </div>

    <script>
        // ============================================================================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // ============================================================================
        
        // ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙØ¹Ù„ÙŠ
        const SERVER_URL = 'http://localhost:8080';
        
        // ============================================================================
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        // ============================================================================
        
        let pc = null;
        let dataChannel = null;
        let stats = {
            bytesReceived: 0,
            packetsReceived: 0,
            frameCount: 0,
            lastStatTime: Date.now()
        };
        
        // ============================================================================
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ============================================================================
        
        function updateStatus(status, indicator) {
            document.getElementById('status-text').textContent = status;
            document.getElementById('status').textContent = status;
            
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.className = 'status-indicator ' + indicator;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function updateStats() {
            const now = Date.now();
            const elapsed = (now - stats.lastStatTime) / 1000;
            
            if (elapsed >= 1) {
                // Ø­Ø³Ø§Ø¨ Bitrate
                const bitrate = (stats.bytesReceived * 8 / elapsed / 1000000).toFixed(2);
                document.getElementById('bitrate').textContent = bitrate + ' Mbps';
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                stats.bytesReceived = 0;
                stats.lastStatTime = now;
            }
        }
        
        // ============================================================================
        // Ø¥Ø¹Ø¯Ø§Ø¯ WebRTC
        // ============================================================================
        
        async function connectToServer() {
            try {
                showLoading(true);
                updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'status-connecting');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                });
                
                // Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£ÙˆØ§Ù…Ø±
                dataChannel = pc.createDataChannel('input', { ordered: true });
                setupDataChannel(dataChannel);
                
                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø«
                pc.ontrack = (event) => {
                    console.log('ğŸ“¹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø«:', event.track.kind);
                    const video = document.getElementById('game-stream');
                    video.srcObject = event.streams[0];
                    updateStatus('Ù…ØªØµÙ„ âœ…', 'status-connected');
                    showLoading(false);
                };
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                pc.ondatachannel = (event) => {
                    console.log('ğŸ“¡ Ù‚Ù†Ø§Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø±Ø¯Ø©:', event.channel.label);
                    setupDataChannel(event.channel);
                };
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                pc.onconnectionstatechange = () => {
                    console.log('ğŸ”Œ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', pc.connectionState);
                    
                    if (pc.connectionState === 'connected') {
                        updateStatus('Ù…ØªØµÙ„ âœ…', 'status-connected');
                        document.getElementById('connect-btn').disabled = true;
                        document.getElementById('disconnect-btn').disabled = false;
                    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                        updateStatus('ØºÙŠØ± Ù…ØªØµÙ„', 'status-disconnected');
                        document.getElementById('connect-btn').disabled = false;
                        document.getElementById('disconnect-btn').disabled = true;
                    }
                };
                
                // Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡
                setInterval(async () => {
                    if (pc && pc.connectionState === 'connected') {
                        try {
                            const statsReport = await pc.getStats();
                            statsReport.forEach(report => {
                                if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©
                                    stats.bytesReceived = report.bytesReceived;
                                    stats.packetsReceived = report.packetsReceived;
                                    
                                    // Ø­Ø³Ø§Ø¨ Latency
                                    if (report.jitter) {
                                        const latency = (report.jitter * 1000).toFixed(2);
                                        document.getElementById('latency').textContent = latency + ' ms';
                                    }
                                    
                                    // Ø­Ø³Ø§Ø¨ FPS
                                    if (report.framesDecoded) {
                                        document.getElementById('fps').textContent = Math.round(report.framesPerSecond || 0);
                                    }
                                    
                                    document.getElementById('packets').textContent = stats.packetsReceived;
                                }
                            });
                            
                            updateStats();
                        } catch (e) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', e);
                        }
                    }
                }, 1000);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
                const response = await fetch(`${SERVER_URL}/offer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status}`);
                }
                
                const answer = await response.json();
                console.log('ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¨Ø¹ÙŠØ¯
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                document.getElementById('server-addr').textContent = SERVER_URL;
                document.getElementById('conn-state').textContent = 'Ù…ØªØµÙ„';
                document.getElementById('conn-type').textContent = 'WebRTC';
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
                showLoading(false);
                updateStatus('Ø®Ø·Ø£', 'status-disconnected');
            }
        }
        
        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('ğŸ“¡ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØªÙˆØ­Ø©');
            };
            
            channel.onclose = () => {
                console.log('ğŸ“¡ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØºÙ„Ù‚Ø©');
            };
            
            channel.onerror = (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            };
        }
        
        function sendInput(inputData) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(inputData));
            }
        }
        
        // ============================================================================
        // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        // ============================================================================
        
        // Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        document.addEventListener('keydown', (e) => {
            sendInput({
                type: 'key',
                key: e.key,
                code: e.code
            });
        });
        
        // Ø§Ù„Ù…Ø§ÙˆØ³
        const video = document.getElementById('game-stream');
        video.addEventListener('click', (e) => {
            const rect = video.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width * 1280;
            const y = (e.clientY - rect.top) / rect.height * 720;
            
            sendInput({
                type: 'mouse',
                x: Math.round(x),
                y: Math.round(y)
            });
        });
        
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³
        document.getElementById('up-btn').addEventListener('click', () => {
            sendInput({ type: 'key', key: 'ArrowUp' });
        });
        
        document.getElementById('down-btn').addEventListener('click', () => {
            sendInput({ type: 'key', key: 'ArrowDown' });
        });
        
        document.getElementById('left-btn').addEventListener('click', () => {
            sendInput({ type: 'key', key: 'ArrowLeft' });
        });
        
        document.getElementById('right-btn').addEventListener('click', () => {
            sendInput({ type: 'key', key: 'ArrowRight' });
        });
        
        // ============================================================================
        // Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        // ============================================================================
        
        document.getElementById('connect-btn').addEventListener('click', connectToServer);
        
        document.getElementById('disconnect-btn').addEventListener('click', () => {
            if (pc) {
                pc.close();
                pc = null;
            }
            updateStatus('ØºÙŠØ± Ù…ØªØµÙ„', 'status-disconnected');
            document.getElementById('connect-btn').disabled = false;
            document.getElementById('disconnect-btn').disabled = true;
        });
        
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            }
        });
        
        document.getElementById('info-btn').addEventListener('click', () => {
            const infoPanel = document.getElementById('info-panel');
            infoPanel.style.display = infoPanel.style.display === 'none' ? 'block' : 'none';
        });
        
        // ============================================================================
        // ØªÙƒØ§Ù…Ù„ Solana (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // ============================================================================
        
        async function connectWallet() {
            try {
                if (window.solana && window.solana.isPhantom) {
                    const resp = await window.solana.connect();
                    console.log('ğŸ” Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…ØªØµÙ„Ø©:', resp.publicKey.toString());
                    return resp.publicKey.toString();
                } else {
                    console.log('âš ï¸ Ù…Ø­ÙØ¸Ø© Phantom ØºÙŠØ± Ù…Ø«Ø¨ØªØ©');
                    return null;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©:', error);
                return null;
            }
        }
        
        // ============================================================================
        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        // ============================================================================
        
        console.log('ğŸš€ DePIN Cloud Gaming Client');
        console.log('ğŸ“¡ Ø§Ù„Ø³ÙŠØ±ÙØ±:', SERVER_URL);
        console.log('ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§ØªØµÙ„" Ù„Ù„Ø¨Ø¯Ø¡');
        
        updateStatus('Ø¬Ø§Ù‡Ø²', 'status-disconnected');
    </script>
</body>
</html>
