import logging
import asyncio
import os
from pathlib import Path
from fastapi import FastAPI, WebSocket, Request, UploadFile, File
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
import uvicorn

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
from projects.aoi_system.main_aoi import AOISystem

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("AOI-Unified-Server")

class UnifiedServer:
    """
    Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…ÙˆØ­Ø¯ (Unified SSOT)
    ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù€ AOI ÙˆØ§Ù„Ù€ AI Agent ÙˆØ§Ù„Ù€ DeOS ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø©.
    """
    def __init__(self):
        self.app = FastAPI(title="AOI Unified Control System")
        self.aoi = AOISystem()
        self._setup_middleware()
        self._setup_routes()
        self._setup_static()

    def _setup_middleware(self):
        self.app.add_middleware(
            CORSMiddleware,
            allow_origins=["*"],
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
        )

    def _setup_routes(self):
        @self.app.get("/api/status")
        async def get_status():
            return await self.aoi.get_realtime_status()

        @self.app.post("/api/goal")
        async def trigger_goal(goal: str):
            asyncio.create_task(self.aoi.trigger_goal(goal))
            return {"status": "Executing", "goal": goal}

        @self.app.post("/api/swarm/goal")
        async def trigger_swarm(goal: str, agents: int = 10):
            asyncio.create_task(self.aoi.trigger_swarm_goal(goal, agents))
            return {"status": "Swarm Launched", "agents": agents}

        @self.app.post("/api/schedule")
        async def schedule_task(name: str, request: str, task_type: str, time_iso: str):
            from datetime import datetime
            run_at = datetime.fromisoformat(time_iso)
            job_id = await self.aoi.schedule_new_task(name, request, task_type, run_at)
            return {"status": "Scheduled", "job_id": job_id}

        # Ø¯Ù…Ø¬ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù€ AI Agent Ø§Ù„Ù‚Ø¯ÙŠÙ…
        @self.app.post("/api/predict")
        async def predict_motion(data: dict):
            if self.aoi.predictor:
                self.aoi.predictor.record_motion(tuple(data.get('pos', [0,0])), data.get('ts', 0))
                return self.aoi.predictor.predict_next_position()
            return {"error": "Predictor module not loaded"}

        @self.app.post("/api/gallery/upload")
        async def upload_media(file: UploadFile = File(...)):
            content = await file.read()
            # Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ù…Ø¹Ø±Ø¶
            return {"status": "Success", "filename": file.filename, "size": len(content)}

        @self.app.websocket("/ws/monitor")
        async def websocket_monitor(websocket: WebSocket):
            await websocket.accept()
            try:
                while True:
                    stats = await self.aoi.get_realtime_status()
                    await websocket.send_json(stats)
                    await asyncio.sleep(2)
            except Exception:
                pass

    def _setup_static(self):
        # ØªÙˆØ­ÙŠØ¯ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù€ Frontend
        frontend_path = Path("projects/ai_agent/frontend")
        if frontend_path.exists():
            self.app.mount("/static", StaticFiles(directory=str(frontend_path)), name="static")
            logger.info(f"ğŸ“ Mounted frontend from {frontend_path}")

    async def start(self):
        await self.aoi.initialize()
        config = uvicorn.Config(self.app, host="0.0.0.0", port=8000, log_level="info")
        server = uvicorn.Server(config)
        await server.serve()

if __name__ == "__main__":
    server = UnifiedServer()
    asyncio.run(server.start())
